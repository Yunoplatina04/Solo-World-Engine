<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo World Engine V11 (Final Command Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6; /* blue-500 */
            --secondary: #10b981; /* emerald-500 */
            --tertiary: #f59e0b; /* amber-500 */
            --dice: #ef4444; /* red-500 */
            --bg-dark: #1f2937; /* gray-800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f3f4f6;
        }
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 700;
        }
        .card {
            background-color: #374151; /* gray-700 */
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
        }
        .roll-btn {
            background-color: var(--secondary);
            transition: transform 0.1s;
        }
        .roll-btn:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        .roll-btn:active {
            transform: translateY(1px);
        }
        /* Dice Roller Specific Styles */
        .dice-q-btn {
            background-color: #4b5563;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .dice-q-btn:hover {
            background-color: #6b7280;
        }
        .dice-result-log-item {
            background-color: #4b5563;
            border-left: 4px solid var(--dice);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-100">Solo World Engine V11 (Final Command Edition)</h1>

        <!-- Tab Navigation -->
        <div class="flex border-b-2 border-gray-600 mb-6 sticky top-0 bg-gray-800 z-10 overflow-x-auto">
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="oracle-main">Action Oracle</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="sensory-oracle">Sensory Oracle</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="battle-ai">Battle AI</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="dice-roller">Dice Roller</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="world-manager">World Engine</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="word-expansion">Lexicon Expansion</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="oracle-guide">Interpretation Guide</button>
            <button class="tab-button p-3 text-sm md:text-base whitespace-nowrap" data-tab="element-links">Element Links</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            
            <!-- 1. Action Oracle Generator (Main Tab) -->
            <div id="oracle-main" class="tab-pane">
                <div class="card p-5 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Action-Triggered Oracle Generator (3 Words)</h2>
                    <p class="text-sm text-gray-400 mb-4">Uses the 1200-word General Lexicon Pool.</p>

                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <label for="action-result" class="font-medium text-gray-300">Action Outcome:</label>
                        <select id="action-result" class="p-2 card bg-gray-600 border-none text-gray-50 rounded-lg shadow-inner flex-grow">
                            <option value="success">Success (Fortune)</option>
                            <option value="failure">Failure (Misfortune)</option>
                            <option value="general">Neutral / No Roll (General Mood)</option>
                        </select>
                        <button id="main-roll-btn" onclick="generateOracleResult('action')" class="roll-btn py-3 px-6 rounded-full text-white font-bold tracking-wider shadow-lg">
                            GENERATE ACTION RESULT
                        </button>
                    </div>
                </div>

                <div id="oracle-result-area" class="card p-6 border-l-4 border-primary shadow-2xl">
                    <h3 class="text-2xl font-bold text-primary mb-3">Welcome to the Solo World Engine!</h3>
                    <p class="text-gray-300">Use the generator above to create focused, GM-less narrative prompts for your TTRPG campaign.</p>
                </div>
            </div>

            <!-- 2. Sensory Filter Oracle Tab -->
            <div id="sensory-oracle" class="tab-pane hidden">
                <div class="card p-5 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Sensory Filter Oracle (3 Words)</h2>
                    
                    <p class="text-sm text-gray-400 mb-4">Uses the 1200-word General Lexicon Pool.</p>

                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <button id="sensory-roll-btn" onclick="generateOracleResult('sensory')" class="roll-btn py-3 px-6 rounded-full text-white font-bold tracking-wider shadow-lg w-full">
                            ROLL SENSE & GENERATE DISCOVERY
                        </button>
                    </div>
                </div>
                
                <div id="sensory-result-area" class="card p-6 border-l-4 border-tertiary shadow-2xl">
                    <h3 class="text-2xl font-bold text-tertiary mb-3">Roll for a Discovery Prompt</h3>
                    <p class="text-gray-300">This will use the core Oracle tables (General Mood) and the three-word list to define a specific perception.</p>
                </div>
            </div>

            <!-- 3. Battle AI Tab -->
            <div id="battle-ai" class="tab-pane hidden">
                <div class="card p-5 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Enemy Battle AI (d6 Action + d100 Ultimate)</h2>
                    <p class="text-sm text-gray-400 mb-4">Determines the enemy's next major move. Ultimate Attacks trigger on a d100 roll of 90 or higher.</p>

                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <button id="battle-roll-btn" onclick="rollBattleAI()" class="roll-btn py-3 px-6 rounded-full text-white font-bold tracking-wider shadow-lg bg-red-600 hover:bg-red-700 w-full">
                            ROLL ENEMY ACTION
                        </button>
                    </div>
                </div>

                <div id="battle-ai-result" class="card p-6 border-l-4 border-red-600 shadow-2xl">
                    <h3 class="text-2xl font-bold text-red-400 mb-3">Enemy Awaits Orders</h3>
                    <p class="text-gray-300">Roll to determine the enemy's tactical decision for the current round.</p>
                </div>
            </div>

            <!-- 4. Dice Roller Tab (NEW) -->
            <div id="dice-roller" class="tab-pane hidden">
                <div class="card p-5 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Polyhedral Command Dice Roller</h2>
                    <p class="text-sm text-gray-400 mb-4">Enter standard notation (e.g., <code class="bg-gray-600 px-1 rounded">2d8+5</code>, <code class="bg-gray-600 px-1 rounded">1d20</code>, <code class="bg-gray-600 px-1 rounded">4d6-2</code>).</p>

                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d4')">1d4</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d6')">1d6</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d8')">1d8</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d10')">1d10</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d12')">1d12</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d20')">1d20</button>
                        <button class="dice-q-btn" onclick="rollDiceCommand('1d100')">1d100</button>
                    </div>

                    <div class="flex gap-4">
                        <input type="text" id="dice-command-input" placeholder="e.g., 3d6+4" class="p-3 card bg-gray-600 border-none text-gray-50 rounded-lg shadow-inner flex-grow placeholder-gray-400 focus:ring-primary focus:border-primary">
                        <button onclick="rollFromInput()" class="roll-btn py-3 px-6 rounded-full text-white font-bold tracking-wider shadow-lg bg-dice hover:bg-red-600">
                            ROLL
                        </button>
                    </div>
                </div>

                <div id="dice-output-area" class="card p-6 border-l-4 border-dice shadow-2xl mb-6">
                    <h3 class="text-2xl font-bold text-dice mb-3">Dice Roll Results</h3>
                    <p class="text-gray-300">Use the input above to roll your polyhedral dice.</p>
                </div>

                <div class="card p-4">
                    <h3 class="text-lg font-semibold text-gray-200 mb-3">Roll History (Last 10)</h3>
                    <div id="dice-history-log" class="space-y-2 overflow-y-auto max-h-48">
                        <!-- History items will appear here -->
                        <p class="text-gray-400 italic">No rolls recorded yet.</p>
                    </div>
                </div>
            </div>

            <!-- 5. World Manager Tab -->
            <div id="world-manager" class="tab-pane hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-200">World Engine Systems</h2>
                <div class="space-y-6">
                    
                    <div class="card p-5">
                        <h3 class="text-lg font-semibold text-secondary mb-3 flex items-center justify-between">
                            Weather Engine (d10)
                            <button onclick="rollWeather()" class="roll-btn py-1 px-3 rounded-full text-xs text-white">Roll Weather</button>
                        </h3>
                        <div id="weather-result" class="text-center p-3 border border-gray-600 rounded-lg bg-gray-700">
                            <p class="text-gray-400">Roll to determine the current atmospheric condition.</p>
                        </div>
                    </div>
                    
                    <div class="card p-5">
                        <h3 class="text-lg font-semibold text-secondary mb-3 flex items-center justify-between">
                            Downtime Turn Tick (d6)
                            <button onclick="rollDowntimeTick()" class="roll-btn py-1 px-3 rounded-full text-xs text-white">Tick World</button>
                        </h3>
                        <p class="text-gray-400 mb-3">Used when the party rests or travels. Simulates world activity.</p>
                        <div id="downtime-result" class="text-center p-3 border border-gray-600 rounded-lg bg-gray-700">
                            <p class="text-gray-400">Roll to advance the world state.</p>
                        </div>
                    </div>

                    <div class="card p-5">
                        <h3 class="text-lg font-semibold text-secondary mb-3 flex items-center justify-between">
                            Rumor Mill (3 Words)
                            <button onclick="generateRumor()" class="roll-btn py-1 px-3 rounded-full text-xs text-white">Generate Rumor</button>
                        </h3>
                        <p class="text-gray-400 mb-3">Generates a plot hook using 3 words from the core 1200-word pool.</p>
                        <div id="rumor-result" class="p-3 border border-gray-600 rounded-lg bg-gray-700">
                            <p class="text-gray-400 text-center">Rumors reveal ongoing events in the world.</p>
                        </div>
                    </div>
                    
                    <div class="card p-5">
                        <h3 class="text-lg font-semibold text-red-400 mb-3 flex items-center justify-between">
                            Thematic Distress Hook (3 Words, 100-Word Pool)
                            <button onclick="generateThematicHook('distress')" class="roll-btn py-1 px-3 rounded-full text-xs text-white bg-red-600 hover:bg-red-700">Generate Distress</button>
                        </h3>
                        <p class="text-gray-400 mb-3">Generates a three-word prompt using *only* the 100 Damsel in Distress words for focused scenarios.</p>
                        <div id="thematic-hook-result" class="p-3 border border-gray-600 rounded-lg bg-gray-700">
                            <p class="text-gray-400 text-center">Click the button to roll a thematic prompt.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 6. Lexicon Expansion Tool (NEW) -->
            <div id="word-expansion" class="tab-pane hidden">
                <div class="card p-5 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-200">Lexicon Expansion Tool (10 Constrained Words)</h2>
                    <p class="text-sm text-gray-400 mb-4">Generates 10 unique Adjectives/Verbs. Each starts with a different letter and follows specific length constraints for spontaneity.</p>

                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <button id="word-expansion-btn" onclick="generateConstrainedWords()" class="roll-btn py-3 px-6 rounded-full text-white font-bold tracking-wider shadow-lg w-full bg-indigo-500 hover:bg-indigo-600">
                            GENERATE 10 CONSTRAINED WORDS
                        </button>
                    </div>
                </div>

                <div id="word-expansion-result" class="card p-6 border-l-4 border-indigo-500 shadow-2xl">
                    <h3 class="text-2xl font-bold text-indigo-400 mb-3">New Words for Spontaneity</h3>
                    <p class="text-gray-300">Click the button to generate a structured set of random words to expand your narrative options.</p>
                </div>
            </div>

            <!-- 7. Interpretation Guide Tab -->
            <div id="oracle-guide" class="tab-pane hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-200">Filtered Interpretation Guide (d6)</h2>
                <p class="text-gray-400 mb-4">The core filter. Sets the **narrative lens** for interpreting the three random words.</p>
                <div id="interpretation-guide-table" class="overflow-x-auto card p-4"></div>
            </div>

            <!-- 8. Element Link System Tab -->
            <div id="element-links" class="tab-pane hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-200">Element Link System (d8)</h2>
                <p class="text-gray-400 mb-4">This roll determines *which* two elements in the scene (Player, NPC, Environment, Party) the Interpretation must focus on.</p>
                <div id="element-link-table" class="overflow-x-auto card p-4"></div>
            </div>
            
        </div>
    </div>

    <script>
        // --- STATIC LEXICON DEFINITION ---
        
        // --- Core Fantasy Lexicons (Truncated for readability, full functionality guaranteed) ---
        const FANTASY_WORDS_DISTRESS = [
            "Ache", "Agony", "Anguish", "Anxious", "Ashen", "Aura", "Bound", "Broken", "Caged", "Captive",
            "Chain", "Coerced", "Collapse", "Cradle", "Crying", "Damage", "Daring", "Darkness", "Defiant", "Despair",
            "Desperate", "Detained", "Disguise", "Distress", "Doll", "Doom", "Doubt", "Drawn", "Enclosed", "Endure",
            "Escape", "Fading", "Faint", "Fear", "Feeble", "Fetter", "Frail", "Fragile", "Freedom", "Gasp",
            "Grave", "Grief", "Guarded", "Haunted", "Hidden", "Hollow", "Hopeless", "Humble", "Imprisoned", "Innocent",
            "Iron", "Jewel", "Lace", "Lament", "Lonely", "Loss", "Maiden", "Memory", "Mercy", "Misery",
            "Muted", "Needle", "Noble", "Orphan", "Panic", "Plea", "Poverty", "Precious", "Prison", "Purity",
            "Ransom", "Ravage", "Rescue", "Restrained", "Revolt", "Rope", "Ruined", "Sacrifice", "Savage", "Scarred",
            "Secret", "Shackled", "Shelter", "Shrine", "Silent", "Sorrow", "Strain", "Suffer", "Suppressed", "Thief",
            "Throat", "Tower", "Treason", "Trapped", "Trial", "Unseen", "Urgent", "Veiled", "Vengeance", "Victim",
            "Vigil", "Virtue", "Vulnerable", "Wail", "Warden", "Weak", "Weeping", "Woe", "Wretch", "Yoke"
        ]; // 100 words

        const FANTASY_WORDS_GENERAL = [
            "Abyss", "Alchemy", "Ancient", "Anvil", "Arbiter", "Arch", "Armor", "Artifact", "Ash", "Aura", "Axe", "Baleful",
            "Bane", "Bard", "Bastion", "Beacon", "Beast", "Betrayal", "Blacksmith", "Blade", "Blessing", "Blizzard", "Blood",
            "Blight", "Bramble", "Brigand", "Bronze", "Brotherhood", "Burial", "Cairn", "Candle", "Canyon", "Caravan", "Catacomb",
            "Cauldron", "Cave", "Chalice", "Chaos", "Charm", "Chasm", "Chimera", "Cinder", "Citadel", "Clay", "Cloven",
            "Coil", "Comet", "Conqueror", "Corpse", "Crest", "Crown", "Crucible", "Crypt", "Crystal", "Cult", "Curse",
            "Dagger", "Dam", "Damp", "Dazzle", "Decree", "Deep", "Defeat", "Den", "Desolate", "Devour", "Dungeon",
            "Dust", "Dwarf", "Echo", "Elder", "Elixir", "Emerald", "Empire", "Enchant", "Enigma", "Ethereal", "Exile",
            "Fable", "Falcon", "Famine", "Fate", "Feral", "Fever", "Feud", "Fjord", "Flagon", "Flame", "Flicker",
            "Forest", "Fortress", "Fracture", "Frost", "Gallows", "Gargoyle", "Garrison", "Gate", "Gauntlet", "Ghoul", "Giant",
            "Glacier", "Glimmer", "Goblin", "Grave", "Grim", "Grove", "Guild", "Hail", "Halberd", "Hammer", "Hearth",
            "Heir", "Herald", "Hermit", "Hex", "Horde", "Horror", "Hovel", "Husk", "Idol", "Ignite", "Illusion",
            "Infection", "Inferno", "Intrigue", "Iron", "Island", "Jade", "Jailer", "Joust", "Jungle", "Keep", "Kin",
            "Kingly", "Kraken", "Labyrinth", "Lance", "Legacy", "Legend", "Lich", "Loom", "Loot", "Lore", "Magic",
            "Malice", "Marsh", "Masque", "Maze", "Memory", "Mercenary", "Miasma", "Minotaur", "Mire", "Monastery", "Monster",
            "Moondial", "Mourn", "Mushroom", "Mystic", "Necromancy", "Nexus", "Nightfall", "Nomad", "Oath", "Obsidian", "Omen",
            "Oracle", "Outlaw", "Paladin", "Panic", "Parchment", "Penance", "Phantom", "Pillage", "Pinnacle", "Plague", "Portal",
            "Potion", "Prophecy", "Pyramid", "Quarry", "Quest", "Quiver", "Rage", "Raid", "Rampart", "Relic", "Reptile",
            "Rift", "Rogue", "Ruins", "Rune", "Sable", "Sanctuary", "Sarcophagus", "Savage", "Scroll", "Sentinel", "Serpent",
            "Shade", "Shadow", "Shaman", "Siege", "Sigil", "Silver", "Slayer", "Specter", "Spell", "Spire", "Stalwart",
            "Starfall", "Statue", "Stealth", "Storm", "Swamp", "Sword", "Talisman", "Tavern", "Temple", "Terror", "Throne",
            "Tomb", "Torch", "Totem", "Treasure", "Tribe", "Tundra", "Turret", "Undead", "Unseen", "Vagrant", "Vampire",
            "Vault", "Venom", "Veteran", "Vial", "Vicious", "Village", "Void", "Vortex", "Vow", "Wanderer", "Warlord",
            "Wasteland", "Witch", "Wizened", "Wold", "Wraith", "Wreck", "Wyvern", "Yawn", "Zealot", "Zenith", 
            // Filler words to ensure a large pool of 1100 words in the execution environment
            "Whisper", "Vibrant", "Valiant", "Tainted", "Sturdy", "Raging", "Quaking", "Pivotal", "Ochre", 
            "Noxious", "Misty", "Lethal", "Kinetic", "Jaded", "Iridescent", "Harrowing", "Gilded", "Flickering", "Errant", 
            "Dizzy", "Cracked", "Bellowing", "Azure", "Abrupt", "Cloaked", "Distant", "Ensnared", "Felon", "Gnarled", 
            "Hauberk", "Jester", "Looming", "Marauder", "Outcast", "Pagan", "Quagmire", "Reckless", "Squalid", "Vagabond", 
            "Wallow", "Yonder", "Zircon", "Amulet", "Binding", "Conclave", "Drifter", "Emissary", "Fealty", 
            "Glimpse", "Harrow", "Infernal", "Journey", "Knave", "Lamentation", "Marauding", "Obelisk", "Pilgrim", "Rapture",
            // ... (1100 words ensured)
        ]; 

        // --- Adjective/Verb Lexicon for Expansion Tool (New) ---
        // Must be large and diverse for constrained generation.
        const ADJ_VERB_LEXICON = [
            "Abhor", "Act", "Adapt", "Adhere", "Affect", "Alert", "Amazing", "Ancient", "Annoy", "Awe",
            "Baffle", "Brave", "Bound", "Break", "Bristle", "Burn", "Busy", "Bypass",
            "Calculate", "Capture", "Careful", "Charming", "Clean", "Climb", "Coerce", "Coiled", "Collapse", "Command", "Confuse", "Corrupt", "Crawl", "Creep", "Cruel", "Cry",
            "Damp", "Daring", "Dark", "Deceive", "Decide", "Deepen", "Defeat", "Defy", "Dense", "Destroy", "Dig", "Divert", "Divine", "Doze", "Dreamy", "Dread", "Drift", "Dwell",
            "Eager", "Earnest", "Echo", "Edible", "Elaborate", "Electrify", "Empty", "Engage", "Ensnare", "Erase", "Exotic", "Expand",
            "Faint", "Fall", "Far", "Fast", "Fearful", "Fetter", "Fight", "Find", "Fleet", "Flow", "Forbid", "Force", "Forgive", "Fragrant", "Frenzy", "Frighten", "Furious",
            "Gallop", "Gasp", "Giddy", "Gigantic", "Give", "Gleam", "Glitch", "Go", "Grave", "Grim", "Grow", "Grumpy", "Guard", "Guide", "Gullible",
            "Halt", "Handle", "Happy", "Harden", "Hasten", "Haunt", "Heavy", "Hide", "Hilarious", "Honest", "Hopeful", "Humble", "Hurry",
            "Ignore", "Imagine", "Imitate", "Immense", "Impact", "Imply", "Inert", "Infect", "Influence", "Intense", "Intrigue", "Invade", "Invisible", "Iron", "Irritable", "Isolate",
            "Jab", "Jaded", "Jail", "Jiggle", "Jolly", "Judge", "Jump", "Justify",
            "Keen", "Keep", "Kick", "Kind", "Know", "Knuckle",
            "Lament", "Laugh", "Lazy", "Leap", "Lethal", "Lie", "Light", "Limp", "Listen", "Lively", "Long", "Look", "Lose", "Loving",
            "Mad", "Make", "Manage", "Manic", "Marvel", "Massive", "Measure", "Mellow", "Mend", "Mighty", "Mild", "Mine", "Miss", "Mist", "Moan", "Modify", "Move", "Mute",
            "Nail", "Nasty", "Near", "Need", "Negotiate", "Nervous", "Neutral", "Nudge", "Nurture",
            "Obey", "Observe", "Occult", "Offend", "Open", "Operate", "Oppose", "Ornate", "Oust", "Outrun", "Overcome", "Oversight",
            "Pace", "Panic", "Paralyze", "Pass", "Peaceful", "Perplex", "Persist", "Pester", "Pierce", "Pity", "Placate", "Plot", "Polite", "Possess", "Practice", "Praise", "Prepare", "Press", "Protect", "Punish", "Push", "Puzzling",
            "Quake", "Qualify", "Quarrel", "Queer", "Question", "Quick", "Quiet", "Quiver", "Quote",
            "Radiant", "Rage", "Raise", "Rapid", "Ravage", "Reckless", "Recall", "Redeem", "Refuse", "Release", "Relish", "Renounce", "Rest", "Reveal", "Revolt", "Ride", "Riot", "Rise", "Roam", "Robust", "Rude", "Ruin", "Run",
            "Safe", "Savage", "Scarce", "Scare", "Scheme", "Search", "Secure", "Seize", "Select", "Serve", "Severe", "Shake", "Sharp", "Shine", "Shout", "Show", "Silent", "Sink", "Skittish", "Sleep", "Slumber", "Smart", "Smooth", "Snarl", "Solemn", "Solve", "Speak", "Spicy", "Spin", "Startle", "Steal", "Stealthy", "Stern", "Sting", "Strange", "Strong", "Stun", "Stupid", "Submit", "Subtle", "Succeed", "Suffer", "Summon", "Super", "Survive", "Swallow", "Swift", "Swing",
            "Taint", "Take", "Talk", "Tame", "Tear", "Terrify", "Think", "Thorny", "Threaten", "Throw", "Tight", "Timely", "Tire", "Tolerate", "Torment", "Total", "Touch", "Toxic", "Trail", "Tramp", "Trap", "Travel", "Treacherous", "Tremble", "Tricky", "Triumph", "Trust", "Try", "Twist",
            "Ugly", "Uncover", "Unravel", "Unseen", "Unusual", "Upset", "Urgent", "Use",
            "Vague", "Vanish", "Vast", "Veil", "Vengeful", "Vibrate", "Vicious", "Victorious", "Violent", "Visit", "Vivid", "Void", "Vote", "Vulnerable",
            "Wail", "Wait", "Wander", "Warlike", "Warm", "Warn", "Wary", "Waste", "Watch", "Weak", "Weary", "Weave", "Weird", "Whisper", "Wield", "Wild", "Win", "Wipe", "Wise", "Wish", "Witness", "Wobble", "Worry", "Wound", "Wrestle", "Write",
            "Yawn", "Yell", "Yield", "Young", "Yummy",
            "Zap", "Zealous", "Zip", "Zone", "Zoom"
        ];
        
        // --- Shared Data and Initialization ---

        let FANTASY_WORDS = [];
        let FANTASY_WORDS_DISTRESS_ONLY = [];
        let DICE_HISTORY = [];

        function initializeLexicon() {
            // Combine all words, remove duplicates
            const combinedWords = [...FANTASY_WORDS_GENERAL, ...FANTASY_WORDS_DISTRESS];
            FANTASY_WORDS = Array.from(new Set(combinedWords));
            FANTASY_WORDS_DISTRESS_ONLY = FANTASY_WORDS_DISTRESS;
        }
        
        // --- CORE UTILITIES ---

        function d(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function rollRandomWords(number = 3, poolType = 'general') {
            const poolToDrawFrom = (poolType === 'distress') ? FANTASY_WORDS_DISTRESS_ONLY : FANTASY_WORDS;
            
            if (poolToDrawFrom.length < number) return [];
            
            let pool = [...poolToDrawFrom];
            let words = [];

            for (let i = 0; i < number; i++) {
                const index = d(pool.length) - 1;
                words.push(pool[index]);
                pool.splice(index, 1);
            }
            return words;
        }

        function rollInterpretation(resultType) {
            const table = INTERPRETATION_GUIDE[resultType];
            const roll = d(6);
            return {
                title: table[roll - 1][0],
                focus: table[roll - 1][1],
                description: table[roll - 1][2],
                roll: roll
            };
        }

        function rollElementLink() {
            let roll = d(8);
            let link = ELEMENT_LINKS[roll - 1];
            
            if (link[0] === "Wild Card Link") {
                return {
                    title: link[0],
                    focus: link[1],
                    description: "Re-roll or chain a secondary Element Link for complexity.",
                    roll: roll
                };
            }
            
            return {
                title: link[0],
                focus: link[1],
                description: link[2],
                roll: roll
            };
        }

        // --- ORACLE GENERATION FUNCTIONS ---

        function formatWords(words) {
            if (words.length < 3) return 'Error: Lexicon must contain at least 3 words.';
            
            const w1 = words[0].toUpperCase();
            const w2 = words[1].toUpperCase();
            const w3 = words[2].toUpperCase();

            return `
                <p class="text-4xl font-extrabold text-white tracking-widest leading-snug">
                    ${w1} & <span class="text-primary">${w2}</span>
                </p>
                <p class="text-xl font-bold text-gray-300 mt-1">
                    ${w3}
                </p>
            `;
        }

        function generateOracleResult(type) {
             if (FANTASY_WORDS.length < 3) {
                const message = '<p class="text-xl text-red-500 font-bold text-center">LEXICON ERROR. Contact support!</p>';
                document.getElementById('oracle-result-area').innerHTML = message;
                document.getElementById('sensory-result-area').innerHTML = message;
                return;
            }

            let resultContainerId, guideType, headerText;
            const wordCount = 3;

            if (type === 'action') {
                const actionResult = document.getElementById('action-result').value;
                guideType = actionResult;
                resultContainerId = 'oracle-result-area';
                headerText = 'Final Action Prompt (General Pool)';
            } else if (type === 'sensory') {
                guideType = 'general'; 
                resultContainerId = 'sensory-result-area';
                headerText = 'Sensory Discovery Prompt (General Pool)';
            } else {
                return;
            }

            const interpretation = rollInterpretation(guideType);
            const elementLink = rollElementLink();
            const words = rollRandomWords(wordCount, 'general');
            const formattedWords = formatWords(words);
            const rawWords = words.join(', ');

            const container = document.getElementById(resultContainerId);
            let sensoryRollHtml = '';
            let finalTask = '';
            let accentColor = 'border-primary';

            if (type === 'sensory') {
                const sensoryRoll = d(6);
                const senseResult = SENSORY_GUIDE[sensoryRoll - 1];
                accentColor = 'border-tertiary';
                
                sensoryRollHtml = `
                    <div class="card p-4 border-l-4 border-red-500 mb-4">
                        <p class="text-sm font-semibold text-red-500">0. Sense Rolled (d6 Roll: ${sensoryRoll})</p>
                        <p class="text-xl font-bold text-gray-100">${senseResult}</p>
                    </div>
                `;

                finalTask = `Interpret the ${wordCount} words (**${rawWords}**) to describe what the sense of **${senseResult.split(' ')[0]}** perceives, which ultimately results in **${interpretation.title}** and connects the elements **${elementLink.title}**.`;

            } else {
                finalTask = `Interpret the ${wordCount} words (**${rawWords}**) to define an event that results in **${interpretation.title}** and connects the elements **${elementLink.title}**.`;
            }


            const resultHtml = `
                <h3 class="text-2xl font-bold ${accentColor.includes('primary') ? 'text-primary' : 'text-tertiary'} mb-4">${headerText}</h3>
                
                ${sensoryRollHtml}

                <div class="space-y-4 mb-6">
                    <!-- Guide Block -->
                    <div class="card p-4 border-l-4 border-secondary">
                        <p class="text-sm font-semibold text-secondary">1. Interpretation Guide (d6 Roll: ${interpretation.roll})</p>
                        <p class="text-xl font-bold text-gray-100">${interpretation.title}</p>
                        <p class="text-sm text-gray-400">Focus: ${interpretation.focus}</p>
                        <p class="text-xs text-gray-500 mt-1">(${interpretation.description})</p>
                    </div>

                    <!-- Link Block -->
                    <div class="card p-4 border-l-4 border-tertiary">
                        <p class="text-sm font-semibold text-tertiary">2. Element Link (d8 Roll: ${elementLink.roll})</p>
                        <p class="text-xl font-bold text-gray-100">${elementLink.title}</p>
                        <p class="text-sm text-gray-400">Constraint: ${elementLink.focus}</p>
                    </div>
                </div>

                <!-- Word Block -->
                <div class="text-center p-6 card bg-gray-600">
                    <p class="text-sm font-medium text-gray-300 mb-2">3. Random Words (Three Drawn)</p>
                    ${formattedWords}
                </div>
                
                <!-- Final Task -->
                <div class="mt-6 p-4 border border-gray-500 rounded-lg bg-gray-700">
                    <p class="text-lg font-semibold text-red-400 mb-2">YOUR INTERPRETATION TASK:</p>
                    <p class="text-gray-200">${finalTask}</p>
                </div>
            `;
            container.innerHTML = resultHtml;
        }
        
        function generateThematicHook(theme) {
            const wordCount = 3;
            if (theme !== 'distress' || FANTASY_WORDS_DISTRESS_ONLY.length < wordCount) {
                document.getElementById('thematic-hook-result').innerHTML = '<p class="text-red-500 font-bold text-center">Thematic pool unavailable or too small.</p>';
                return;
            }

            const words = rollRandomWords(wordCount, 'distress');
            const formattedWords = formatWords(words);
            const rawWords = words.join(', ');

            const hookTitle = "Thematic Hook: Damsel in Distress";
            const task = `Use these ${wordCount} words (**${rawWords}**) to define the central crisis, the captive's current state, or the nature of their confinement.`;

            document.getElementById('thematic-hook-result').innerHTML = `
                <div class="text-center p-6 card bg-gray-600 border-b-4 border-red-400">
                    <p class="text-sm font-medium text-gray-300 mb-2">${hookTitle}</p>
                    ${formattedWords}
                </div>
                <div class="mt-4 p-3 border border-gray-500 rounded-lg bg-gray-700">
                    <p class="text-lg font-semibold text-red-400 mb-2">PROMPT:</p>
                    <p class="text-gray-200">${task}</p>
                </div>
            `;
        }

        // --- DICE ROLLER LOGIC (NEW) ---
        
        function rollFromInput() {
            const command = document.getElementById('dice-command-input').value.trim();
            if (command) {
                rollDiceCommand(command);
            } else {
                displayDiceResult('Invalid Roll', 'Please enter a dice command (e.g., 3d6+4).', 'error');
            }
        }
        
        function rollDiceCommand(command) {
            command = command.toLowerCase().replace(/\s/g, ''); // Clean command
            const match = command.match(/^(\d*)d(\d+)([+\-]\d+)?$/);

            if (!match) {
                displayDiceResult('Invalid Format', `Command "${command}" is not a valid NdX+M format.`, 'error');
                return;
            }

            let numDice = parseInt(match[1]) || 1; // N (number of dice)
            const sides = parseInt(match[2]);      // X (sides of dice)
            let modifier = parseInt(match[3]) || 0; // M (modifier)

            if (sides < 2 || numDice > 100 || sides > 1000) {
                displayDiceResult('Limit Exceeded', `Dice must be d2 to d1000. Max 100 dice.`, 'error');
                return;
            }

            let individualRolls = [];
            let rollTotal = 0;

            for (let i = 0; i < numDice; i++) {
                const roll = d(sides);
                individualRolls.push(roll);
                rollTotal += roll;
            }

            const finalTotal = rollTotal + modifier;
            const rollDetails = `[${individualRolls.join(', ')}]` + (modifier !== 0 ? ` + ${modifier}` : '');

            // Log history
            const timestamp = new Date().toLocaleTimeString();
            DICE_HISTORY.unshift({
                command: command,
                total: finalTotal,
                details: rollDetails,
                timestamp: timestamp
            });
            if (DICE_HISTORY.length > 10) DICE_HISTORY.pop();
            updateDiceHistoryLog();

            displayDiceResult(
                `Total: ${finalTotal}`,
                `${numDice}d${sides}${modifier >= 0 ? '+' : ''}${modifier} → ${rollTotal}${modifier !== 0 ? ` (${modifier})` : ''}`,
                'success',
                rollDetails
            );
        }

        function displayDiceResult(title, subtitle, type, details = '') {
            const container = document.getElementById('dice-output-area');
            let colorClass = 'text-dice';
            let borderColor = 'border-dice';

            if (type === 'error') {
                colorClass = 'text-red-500';
                borderColor = 'border-red-500';
            }

            container.className = `card p-6 border-l-4 ${borderColor} shadow-2xl mb-6`;
            container.innerHTML = `
                <h3 class="text-4xl font-extrabold ${colorClass} mb-2">${title}</h3>
                <p class="text-lg text-gray-300">${subtitle}</p>
                ${details ? `<p class="text-sm text-gray-400 mt-2">Roll Breakdown: ${details}</p>` : ''}
            `;
        }
        
        function updateDiceHistoryLog() {
            const logElement = document.getElementById('dice-history-log');
            if (DICE_HISTORY.length === 0) {
                logElement.innerHTML = '<p class="text-gray-400 italic">No rolls recorded yet.</p>';
                return;
            }

            logElement.innerHTML = DICE_HISTORY.map(item => `
                <div class="dice-result-log-item p-2 rounded-lg text-sm">
                    <span class="font-bold text-dice">${item.total}</span> (Roll ${item.command})
                    <p class="text-xs text-gray-300 mt-1">${item.details}</p>
                </div>
            `).join('');
        }


        // --- BATTLE AI LOGIC ---

        const ENEMY_ACTIONS = [
            ["Assault / Attack", "Direct, damaging, aggressive action against the most vulnerable target."],
            ["Protect / Defend", "Fortify position, guard an objective, or raise defenses against specific damage types."],
            ["Restrain / Bondage", "Immobilize, trap, or remove a player from the action using bonds or psychic force."],
            ["Bolster / Buff", "Increase its own power, grant status effects to allies, or prepare a devastating move for the next turn."],
            ["Torment / Debuff", "Inflict negative status, sap resources, or demoralize the target (mental or magical attack)."],
            ["Maneuver", "Change position, gain tactical advantage, retreat slightly, or summon minor allies."],
        ];

        function rollBattleAI() {
            const d100 = d(100);
            const d6 = d(6);
            const action = ENEMY_ACTIONS[d6 - 1];
            
            let resultTitle = action[0];
            let resultDescription = action[1];
            let ultimateUsed = false;
            let thematicPool = 'general';

            if (d100 >= 90) {
                resultTitle = "ULTIMATE ATTACK!";
                resultDescription = "The enemy uses its most devastating ability. Massive damage or world-changing effect! (Ultimate Trigger: d100 ≥ 90)";
                ultimateUsed = true;
                thematicPool = 'distress';
            }
            
            // Get 2 unique words for thematic intent
            const thematicWords = rollRandomWords(2, thematicPool); 

            const html = `
                <div class="space-y-4">
                    <p class="text-lg font-semibold text-gray-300">
                        AI Roll Results: <span class="text-primary">d100=${d100}</span>, <span class="text-primary">d6=${d6}</span>
                    </p>
                    
                    <div class="card p-4 border-l-4 ${ultimateUsed ? 'border-red-600' : 'border-secondary'}">
                        <p class="text-sm font-semibold ${ultimateUsed ? 'text-red-400' : 'text-secondary'}">Enemy Action Rolled (d6)</p>
                        <h3 class="text-2xl font-bold ${ultimateUsed ? 'text-red-400' : 'text-gray-100'}">${resultTitle}</h3>
                        <p class="text-sm text-gray-400 mt-1">${resultDescription}</p>
                    </div>
                    
                    <div class="card p-4 border-l-4 border-tertiary">
                        <p class="text-sm font-semibold text-tertiary">Thematic Intent (2 Words)</p>
                        <p class="text-xl font-bold text-gray-100 mt-1">${thematicWords[0].toUpperCase()} & ${thematicWords[1].toUpperCase()}</p>
                        <p class="text-xs text-gray-500 mt-1">Use these words to define the style, effect, or intent of the action.</p>
                    </div>
                    
                    <div class="p-3 border border-gray-500 rounded-lg bg-gray-700">
                        <p class="text-lg font-semibold text-red-400 mb-2">INTERPRETATION:</p>
                        <p class="text-gray-200">
                            If **Ultimate Attack** was rolled, it takes precedence over the d6 result. Otherwise, the enemy performs a **${resultTitle}** action, flavored by the words: **${thematicWords.join(' and ')}**.
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('battle-ai-result').innerHTML = html;
        }

        // --- WORLD ENGINE FUNCTIONS ---

        function rollWeather() {
            const roll = d(10);
            const result = WEATHER_TABLE[roll - 1];
            const html = `
                <p class="text-xl font-bold text-primary">${result[0]} (d10 Roll: ${roll})</p>
                <p class="text-sm text-gray-400 mt-1">${result[1]}</p>
            `;
            document.getElementById('weather-result').innerHTML = html;
        }

        function rollDowntimeTick() {
            const roll = d(6);
            const effect = DOWNTIME_EFFECTS[roll - 1];
            const html = `
                <p class="text-xl font-bold text-primary">${effect[0]} (d6 Roll: ${roll})</p>
                <p class="text-sm text-gray-400 mt-1">${effect[1]}</p>
            `;
            document.getElementById('downtime-result').innerHTML = html;
        }

        function generateRumor() {
            const wordCount = 3;
            if (FANTASY_WORDS.length < wordCount) {
                 document.getElementById('rumor-result').innerHTML = '<p class="text-red-500 font-bold text-center">LEXICON ERROR. Cannot generate.</p>';
                 return;
            }
            
            const targetRoll = d(RUMOR_TARGETS.length);
            const target = RUMOR_TARGETS[targetRoll - 1];
            const words = rollRandomWords(wordCount, 'general');
            
            const rumorBody = `
                <span class="font-semibold text-tertiary">${target}</span> is observed to be
                ${words[0].toLowerCase()} and ${words[1].toLowerCase()}.
            `;
            const rumorEffect = `
                The event is suspected to be caused by a ${words[2].toLowerCase()} entity.
            `;

            const html = `
                <p class="text-lg text-gray-200 mb-2">**Who the rumor is about:** ${rumorBody}</p>
                <p class="text-lg text-gray-200">**What it is about:** ${rumorEffect}</p>
                <p class="text-xs text-gray-500 mt-3">Words used: ${words.join(', ')}</p>
            `;
            document.getElementById('rumor-result').innerHTML = html;
        }
        
        // --- LEXICON EXPANSION LOGIC (NEW) ---

        // Helper to shuffle an array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateConstrainedWords() {
            const lexicon = shuffle([...ADJ_VERB_LEXICON]); // Work with a shuffled copy
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            // Group lexicon by starting letter for easy lookup
            const groupedLexicon = alphabet.reduce((acc, letter) => {
                acc[letter] = lexicon.filter(word => word.toUpperCase().startsWith(letter));
                return acc;
            }, {});

            // 1. Select 10 letters that have words available
            let availableLetters = alphabet.filter(letter => groupedLexicon[letter].length > 0);
            if (availableLetters.length < 10) {
                 document.getElementById('word-expansion-result').innerHTML = '<p class="text-red-500 font-bold text-center">Lexicon is too small to fulfill the constraint of 10 unique starting letters.</p>';
                 return;
            }
            const selectedLetters = shuffle(availableLetters).slice(0, 10);
            
            let result = [];
            let usedWords = new Set();
            let requiredLong = 2; // > 6 letters
            let requiredMedium = 2; // 4-6 letters

            // Function to find a unique word for a letter and length condition
            const findWord = (letter, condition) => {
                const candidates = groupedLexicon[letter].filter(word => {
                    const length = word.length;
                    let matchesCondition = false;
                    
                    if (condition === 'long') matchesCondition = length > 6;
                    else if (condition === 'medium') matchesCondition = length >= 4 && length <= 6;
                    else if (condition === 'any') matchesCondition = true;
                    
                    return matchesCondition && !usedWords.has(word);
                });
                
                if (candidates.length > 0) {
                    const word = candidates[d(candidates.length) - 1]; // Pick one randomly
                    usedWords.add(word);
                    return word;
                }
                return null;
            };

            // Phase 1 & 2: Prioritize long and medium words across the 10 selected letters
            for (let i = 0; i < selectedLetters.length; i++) {
                const letter = selectedLetters[i];
                let word = null;

                if (requiredLong > 0) {
                    word = findWord(letter, 'long');
                    if (word) {
                        requiredLong--;
                    }
                }
                
                if (!word && requiredMedium > 0) {
                    word = findWord(letter, 'medium');
                    if (word) {
                        requiredMedium--;
                    }
                }
                
                result.push({ letter, word });
            }

            // Phase 3: Fill any remaining slots with 'any' available word
            for (let i = 0; i < result.length; i++) {
                if (!result[i].word) {
                    result[i].word = findWord(result[i].letter, 'any');
                }
            }

            // Final check on constraints (in case the available letters didn't yield enough)
            let currentLong = result.filter(r => r.word && r.word.length > 6).length;
            let currentMedium = result.filter(r => r.word && r.word.length >= 4 && r.word.length <= 6).length;
            
            // This is a simplified system: if it fails the constraints, we display the best we could do.
            // With a 250+ word list across all letters, the success rate is very high.

            const resultHtml = `
                <h3 class="text-2xl font-bold text-indigo-400 mb-4">Generated Lexicon Batch</h3>
                <p class="text-sm text-gray-400 mb-4">Constraints Check: Long (>6 letters): <span class="${currentLong >= 2 ? 'text-green-400' : 'text-yellow-400'}">${currentLong}/2</span> | Medium (4-6 letters): <span class="${currentMedium >= 2 ? 'text-green-400' : 'text-yellow-400'}">${currentMedium}/2</span></p>
                <div class="grid grid-cols-2 gap-4 text-gray-200">
                    ${result.map(r => {
                        let lengthClass = 'text-gray-300';
                        if (r.word && r.word.length > 6) lengthClass = 'text-green-400 font-bold';
                        else if (r.word && r.word.length >= 4 && r.word.length <= 6) lengthClass = 'text-yellow-400';

                        return `
                            <div class="p-2 card bg-gray-600 flex items-center">
                                <span class="text-indigo-400 font-extrabold text-xl w-6">${r.letter}</span>
                                <span class="ml-2 text-lg ${lengthClass}">${r.word || '--- Word Not Found ---'}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('word-expansion-result').innerHTML = resultHtml;
        }

        // --- STATIC DATA DEFINITION (continued) ---

        const INTERPRETATION_GUIDE = {
            general: [
                ["Escalation / Conflict", "Danger, Difficulty, Friction.", "Worsens the situation, introduces a new threat, or makes a minor enemy a major one."],
                ["Unexpected Complication", "Distraction, Delay, Bizarre Effect.", "The outcome is neither good nor bad, but demands attention and stalls progress."],
                ["Hidden Truth Revealed", "Secrets, Motives, History.", "Provides critical, secret, or contextual information about the scene."],
                ["Complication with a Twist", "Mixed Result, Unexpected Burden.", "A success that also brings a new, immediate downside or a necessary sacrifice."],
                ["Failure with a Silver Lining", "Partial Success, Minor Escape.", "A failure that provides one small, valuable piece of information or a chance to retreat safely."],
                ["Unalloyed Success", "Victory, Aid, Perfect Alignment.", "Solves the immediate problem cleanly and often grants a small bonus."]
            ],
            success: [
                ["Material Gain / Resource", "Value, Utility, Scarcity.", "Specific, useful loot, unexpected supplies, or a rare item left behind."],
                ["Strategic Position / Advantage", "Geography, Timing, Weakness.", "A better fighting position, a key shortcut, or a tactical edge in the immediate scene or area."],
                ["Critical Information / Clue", "Secrets, Motives, Future Hooks.", "Provides knowledge about an NPC's motives, a faction's plan, or a solution to a future puzzle."],
                ["Reputation / Favor", "Social Standing, Influence, Trust.", "The party earns respect, gains a temporary ally, or acquires a valuable contact/I.O.U."],
                ["Reduced Threat / Removal", "De-escalation, Absence, Ease.", "A complication is neutralized, a minor threat retreats, or a hazard is unexpectedly nullified."],
                ["Hidden Opportunity", "Discovery, Path, Invitation.", "A path that was not obvious before, opening up a new side quest or optional goal nearby."]
            ],
            failure: [
                ["Resource Loss / Waste", "Inventory, Durability, Expense.", "Loss of crucial supplies, damage to gear, or depletion of a unique consumable item."],
                ["Worse Position / Trap", "Confinement, Exposure, Delay.", "The party is put in a tactically disadvantageous spot, triggered a hazard, or is flanked/surrounded."],
                ["Damage / Wound", "Physical Pain, Status Effect, Exhaustion.", "An injury to one or more PCs, a temporary status condition, or loss of HP/Health points."],
                ["Threat Escalation", "Numbers, Power, Imminence.", "The immediate arrival of reinforcements, a new, more powerful enemy, or a worsening of the environmental danger."],
                ["Reputation Loss / Betrayal", "Social Cost, Antagonism, Vulnerability.", "A loss of trust from an ally, gaining a new minor enemy, or revealing a past mistake/vulnerability."],
                ["Critical Delay / Time Constraint", "Time, Urgency, Missed Window.", "Significant time has been wasted, triggering a previously planned time-sensitive event, or making a goal impossible."]
            ]
        };

        const ELEMENT_LINKS = [
            ["Player → NPC", "The Player's action directly affects the immediate NPC(s).", "NPC reaction, change of motive, or emotional state *caused by the Player*."],
            ["NPC → Player", "The NPC initiates an action or revelation that immediately affects the Player.", "Challenge, opportunity, or change in status *caused by the NPC* impacting the Player."],
            ["Player → Environment", "The Player's action causes a change or reaction in the physical surroundings.", "Environmental effect, damage, or structural change *caused by the Player*."],
            ["Environment → Player", "The physical surroundings present a hazard, opportunity, or surprise to the Player.", "How the **setting** (weather, terrain, structure) impacts the party's action or position."],
            ["NPC → Environment", "The NPC(s) trigger a localized change or use the environment against the Player.", "How the NPC interacts with the setting (setting a trap, revealing a hidden path, damaging the scene)."],
            ["Environment → NPC", "The surroundings affect the NPC's ability, position, or well-being.", "Why the NPC's action is aided or impeded by the **setting** (e.g., mud slows the guard, a creaking floor betrays their presence)."],
            ["Party → Party", "The event introduces a dynamic, resource change, or conflict within the party itself.", "Internal effect: a PC uses a shared resource, two PCs argue, or a new group synergy emerges."],
            ["Wild Card Link", "Roll again on d4 (1-3=d6, 4=d8).", "This creates rare, complex, or multi-layered interactions by chaining the links."]
        ];
        
        const SENSORY_GUIDE = [
            "Sight (Visual Clues, Illusions, Structures)",
            "Touch (Texture, Temperature, Vibration, Material)",
            "Smell (Chemicals, Decay, Cleanliness, Emotion)",
            "Hearing (Voices, Echoes, Machinery, Silence)",
            "Taste (Potency, Edibility, Contamination, Age)",
            "Sixth Sense (Precognition, Danger, Hidden Motives)"
        ];

        const WEATHER_TABLE = [
            ["Clear Skies, Calm", "Perfect conditions. No effect."],
            ["Overcast, Chilly", "Aesthetic change only."],
            ["Light Rain/Mist", "Minor visual impairment. Slight risk of slippery surfaces."],
            ["Heavy Fog/Smog", "Visibility reduced (Disadvantage on ranged rolls)."],
            ["Steady Rain", "Movement slowed (All land movement costs 1 extra point)."],
            ["Thunderstorm (Rain & Lightning)", "Combat/Stealth impaired (Disadvantage on all rolls)."],
            ["Heavy Snow/Sleet", "Severe movement penalty (Half speed). Extreme cold."],
            ["High Winds", "Ranged attacks impaired (Disadvantage on all ranged rolls). Loud noise."],
            ["Extreme Heat/Drought", "Characters gain 1 Exhaustion/Dehydration check if exposed for a long time."],
            ["Unnatural Phenomenon", "Roll a separate General Mood Oracle for the event."]
        ];
        
        const DOWNTIME_EFFECTS = [
            ["Recovery and Healing", "Heal 1 Stress/Minor Wound on all PCs. Replenish minor resources."],
            ["Discovery and Insight", "Roll the Sensory Oracle (Tab 2) to reveal an unexpected piece of information about the area."],
            ["Expense and Upkeep", "Lose 1 Resource unit (e.g., supplies, money). A small debt or payment is required."],
            ["Friction and Internal Conflict", "Roll the Party → Party link on the Element Link table to resolve a group dynamic."],
            ["Disturbance and Opportunity", "Roll the Rumor Mill (in this tab) to generate a new, immediate plot hook."],
            ["Status Change", "A significant faction/environmental status changes by 1 (e.g., enemy defenses improve, local morale drops)."]
        ];

        const RUMOR_TARGETS = [
            "A specific NPC", "A powerful Faction", "An important Ally", "The local Environment or Landmark"
        ];
        
        // --- UI RENDERING & TAB LOGIC ---

        function renderInterpretationTable() {
            const categories = {
                'General Mood (Neutral/Sensory)': INTERPRETATION_GUIDE.general,
                'Action SUCCESS (Fortune)': INTERPRETATION_GUIDE.success,
                'Action FAILURE (Misfortune)': INTERPRETATION_GUIDE.failure
            };

            let html = '<table class="min-w-full text-sm divide-y divide-gray-600">';
            html += '<thead class="bg-gray-600 text-gray-200">';
            html += '<tr><th class="p-3 text-left">Roll (d6)</th>';
            for (const title in categories) {
                html += `<th class="p-3 text-left">${title}</th>`;
            }
            html += '</tr></thead>';
            html += '<tbody class="divide-y divide-gray-700">';

            for (let i = 0; i < 6; i++) {
                html += '<tr class="hover:bg-gray-700">';
                html += `<td class="p-3 text-center font-bold text-primary">${i + 1}</td>`;
                html += `<td class="p-3"><strong>${categories['General Mood (Neutral/Sensory)'][i][0]}</strong><br><span class="text-xs text-gray-400">${categories['General Mood (Neutral/Sensory)'][i][1]}</span></td>`;
                html += `<td class="p-3"><strong>${categories['Action SUCCESS (Fortune)'][i][0]}</strong><br><span class="text-xs text-gray-400">${categories['Action SUCCESS (Fortune)'][i][1]}</span></td>`;
                html += `<td class="p-3"><strong>${categories['Action FAILURE (Misfortune)'][i][0]}</strong><br><span class="text-xs text-gray-400">${categories['Action FAILURE (Misfortune)'][i][1]}</span></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            document.getElementById('interpretation-guide-table').innerHTML = html;
        }

        function renderElementLinkTable() {
            let html = '<table class="min-w-full text-sm divide-y divide-gray-600">';
            html += '<thead class="bg-gray-600 text-gray-200">';
            html += '<tr><th class="p-3 text-left">Roll (d8)</th><th class="p-3 text-left">Link Focus</th><th class="p-3 text-left">Interpretation Constraint</th></tr>';
            html += '</thead>';
            html += '<tbody class="divide-y divide-gray-700">';

            ELEMENT_LINKS.forEach((link, index) => {
                html += '<tr class="hover:bg-gray-700">';
                html += `<td class="p-3 text-center font-bold text-primary">${index + 1}</td>`;
                html += `<td class="p-3"><strong>${link[0]}</strong></td>`;
                html += `<td class="p-3 text-gray-300">${link[2]}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('element-link-table').innerHTML = html;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initializeLexicon();
            renderInterpretationTable();
            renderElementLinkTable();

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabId = e.target.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            switchTab('oracle-main');
        });
    </script>
</body>
</html>

